---
layout: bloc
title: "Cas d'ús: Catàleg amb dades remotes i gestió avançada"
unitat: 3
bloc: 4
bloc_numero: 4
---

<!-- SECCIÓ 0: Introducció -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio0">
  <h2 id="Unitat3_Bloc4_Seccio0">Introducció</h2>

  <!-- MULTIMÈDIA -->
  {% include multimedia-youtube.html unitat=3 bloc=4 seccio=0 %}

  <div class="info_box">
    <p>Després de les 9 lectures de la Unitat 3, disposeu dels conceptes necessaris per construir una aplicació Angular que consumeix dades reals d'una API externa, les transforma amb adaptadors, gestiona els seus estats (càrrega, èxit, error) i ofereix formularis avançats amb validacions personalitzades i camps dinàmics.</p>

    <p>Aquest cas d'ús integra tots aquests conceptes en una aplicació funcional: un <strong>catàleg d'elements</strong> que carrega dades populars, permet cercar elements amb validació asíncrona, gestiona preferits locals amb persistència i ofereix un formulari dinàmic per afegir notes.</p>

    <p>L'aplicació que construireu és la base tècnica que podreu ampliar a la Unitat 4 amb navegació, rutes i optimització. Per això és fonamental que acabeu amb una aplicació robusta i ben documentada.</p>
  </div>

  <h3>Objectius del cas d'ús</h3>

  <ul>
    <li>Configurar l'accés a un servei extern (mock server amb json-server o API real) i documentar la configuració</li>
    <li>Implementar models TypeScript amb interfícies i adaptadors per transformar dades externes</li>
    <li>Crear serveis Angular amb <code>HttpClient</code> que gestionen estats de càrrega, èxit i error</li>
    <li>Construir formularis reactius amb validacions personalitzades síncrones i asíncrones</li>
    <li>Implementar gestió de preferits locals amb persistència a <code>localStorage</code></li>
    <li>Desenvolupar formularis dinàmics amb <code>FormArray</code> per gestionar notes</li>
  </ul>

  <h3>Resultats d'Aprenentatge i criteris coberts</h3>

  <ul>
    <li><strong>RA3 · Criteri 1</strong> — Defineix models de dades i estructures adequades al cas d'ús.</li>
    <li><strong>RA3 · Criteri 2</strong> — Utilitza serveis externs (APIs web) per obtenir, enviar i actualitzar informació.</li>
    <li><strong>RA3 · Criteri 3</strong> — Actualitza la interfície de manera reactiva davant canvis en les dades.</li>
    <li><strong>RA3 · Criteri 4</strong> — Gestiona estats de càrrega, errors i reintents amb criteri d'usuabilitat.</li>
    <li><strong>RA3 · Criteri 5</strong> — Documenta el flux de dades i les decisions preses per garantir mantenibilitat.</li>
  </ul>

  <h3>Lectures integrades</h3>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Lliçó</th>
        <th>Lectura</th>
        <th>Concepte aplicat</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td rowspan="3"><strong>3.1</strong></td>
        <td>3.1.1</td>
        <td>Creació de serveis i separació de responsabilitats</td>
      </tr>
      <tr>
        <td>3.1.2</td>
        <td>Client de peticions i comunicació amb serveis web</td>
      </tr>
      <tr>
        <td>3.1.3</td>
        <td>Gestió d'errors i estats de càrrega</td>
      </tr>
      <tr>
        <td rowspan="3"><strong>3.2</strong></td>
        <td>3.2.1</td>
        <td>Definició de models amb interfícies</td>
      </tr>
      <tr>
        <td>3.2.2</td>
        <td>Adaptadors i transformació de dades externes</td>
      </tr>
      <tr>
        <td>3.2.3</td>
        <td>Integració reactiva amb components</td>
      </tr>
      <tr>
        <td rowspan="3"><strong>3.3</strong></td>
        <td>3.3.1</td>
        <td>Formularis reactius: grups i controls</td>
      </tr>
      <tr>
        <td>3.3.2</td>
        <td>Validacions personalitzades i asíncrones</td>
      </tr>
      <tr>
        <td>3.3.3</td>
        <td>Formularis complexos i camps dinàmics</td>
      </tr>
    </tbody>
  </table>

</div>

<!-- SECCIÓ 1: Prerequisits -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio1">
  <h2 id="Unitat3_Bloc4_Seccio1">1. Prerequisits</h2>

  <p>Abans de començar aquest cas d'ús, necessiteu tenir preparat:</p>

  <h3>1.1. Projecte Angular funcional</h3>

  <ul>
    <li>Projecte <code>catalog-elements</code> inicialitzat amb Angular CLI 18+</li>
    <li>Git configurat amb repositori local inicialitzat</li>
    <li>Node.js i npm operatius (versions LTS 20.x o superior)</li>
  </ul>

  <h3>1.2. Coneixements de la Unitat 3</h3>

  <ul>
    <li>Lectures 3.1.1 a 3.1.3 (serveis i comunicació HTTP)</li>
    <li>Lectures 3.2.1 a 3.2.3 (models i adaptadors)</li>
    <li>Lectures 3.3.1 a 3.3.3 (formularis avançats)</li>
  </ul>

  <h3>1.3. Documentació preparada</h3>

  <ul>
    <li>Carpeta <code>docs/</code> amb fitxers <code>serveis.md</code>, <code>models.md</code>, <code>formularis.md</code></li>
    <li>Mock de dades: <code>src/app/mocks/dades-elements.mock.ts</code></li>
  </ul>

  <h3>1.4. Verificació ràpida</h3>

  <p>Executeu les següents comandes per assegurar-vos que el vostre entorn està llest:</p>

{% capture code_001 %}cd ~/workspace/catalog-elements
ng version
git status{% endcapture %}
{% include code-block.html lang="bash" code=code_001 %}

  <p><strong>Punt d'autocomprovació:</strong> Veieu Angular CLI ≥18.0.0, <code>git status</code> mostra "working tree clean".</p>

</div>

<!-- SECCIÓ 2: Visió general de l'aplicació -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio2">
  <h2 id="Unitat3_Bloc4_Seccio2">2. Visió general de l'aplicació</h2>

  <h3>2.1. Què construireu</h3>

  <p>Una aplicació Angular completa amb quatre funcionalitats principals:</p>

  <ol>
    <li><strong>Llistat de populars:</strong> Carrega automàticament els elements més populars de l'API</li>
    <li><strong>Cerca d'elements:</strong> Formulari reactiu que filtra elements per nom amb validació asíncrona</li>
    <li><strong>Gestió d'estats:</strong> Indicadors visuals de càrrega, missatges d'error i gestió de reintents</li>
    <li><strong>Preferits locals:</strong> Sistema per marcar elements favorits amb notes dinàmiques persistents</li>
  </ol>

  <h3>2.2. Arquitectura de l'aplicació</h3>

{% capture code_002 %}src/app/
├── models/
│   └── element.model.ts          # Interfícies TypeScript
├── adaptadors/
│   └── element.adaptador.ts      # Funcions de transformació
├── serveis/
│   ├── element.service.ts        # Servei HTTP amb signals
│   └── preferits.service.ts      # Servei de persistència local
├── components/
│   ├── cataleg-page/             # Pàgina principal del catàleg
│   ├── element-card/             # Targeta individual d'element
│   ├── formulari-cerca/          # Formulari de cerca reactiu
│   └── preferits-panel/          # Panell de preferits
└── validadors/
    └── codi-disponible.validator.ts  # Validador asíncron{% endcapture %}
{% include code-block.html lang="plaintext" code=code_002 %}

  <h3>2.3. Flux de dades</h3>

  <ol>
    <li>Component <code>CatalegPage</code> crida servei <code>ElementService.obtenirPopulars()</code></li>
    <li>Servei fa petició HTTP a l'API</li>
    <li>Adaptador transforma resposta JSON → model <code>ElementCataleg</code></li>
    <li>Component rep dades via signal i actualitza la vista</li>
    <li>Formulari de cerca valida entrada i filtra elements</li>
    <li>Preferits s'emmagatzemen a <code>localStorage</code> amb notes dinàmiques</li>
  </ol>

  <h3>2.4. Funcionalitats per bloc</h3>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Bloc</th>
        <th>Acció</th>
        <th>Resultat</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>Bloc 1</strong></td>
        <td>Configurar servidor mock amb json-server</td>
        <td>API REST local funcional</td>
      </tr>
      <tr>
        <td><strong>Bloc 2</strong></td>
        <td>Crear models i adaptadors</td>
        <td>Interfícies i funcions de transformació</td>
      </tr>
      <tr>
        <td><strong>Bloc 3</strong></td>
        <td>Implementar servei HTTP</td>
        <td>Servei amb gestió d'estats i errors</td>
      </tr>
      <tr>
        <td><strong>Bloc 4</strong></td>
        <td>Desenvolupar llistat reactiu</td>
        <td>Component amb signals i indicadors visuals</td>
      </tr>
      <tr>
        <td><strong>Bloc 5</strong></td>
        <td>Crear formulari de cerca</td>
        <td>Formulari amb validació asíncrona</td>
      </tr>
      <tr>
        <td><strong>Bloc 6</strong></td>
        <td>Implementar preferits i notes</td>
        <td>Sistema de persistència amb FormArray</td>
      </tr>
    </tbody>
  </table>

</div>

<!-- SECCIÓ 3: Configuració de l'API i entorn -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio3">
  <h2 id="Unitat3_Bloc4_Seccio3">3. Configuració de l'API i entorn</h2>

  <div class="info_box">
    <p><strong>Objectiu:</strong> Configurar un servidor mock amb json-server per simular una API REST real.</p>
    <p><strong>Integra conceptes de:</strong> Lectura 3.1.2 (Client de peticions i comunicació amb serveis web), Lectura 3.1.3 (Gestió d'errors i estats de càrrega).</p>
  </div>

  <h3>3.1. Crear estructura de l'API mock</h3>

  <p>Crearem un servidor mock amb <code>json-server</code> per simular una API REST real.</p>

{% capture code_003 %}cd ~/workspace/catalog-elements
mkdir -p tools/api
touch tools/api/cataleg.json
code tools/api/cataleg.json{% endcapture %}
{% include code-block.html lang="bash" code=code_003 %}

  <h3>3.2. Omplir fitxer de dades mock</h3>

  <p>Afegiu el següent contingut al fitxer <code>tools/api/cataleg.json</code>:</p>

{% capture code_004 %}{
  "elements": [
    {
      "id": "elem-001",
      "nom": "Placa Arduino Uno R3",
      "descripcio": "Microcontrolador amb processador ATmega328P",
      "categoria": "Electronics",
      "preu": 24.99,
      "imatge": "https://via.placeholder.com/300x200?text=Arduino",
      "popular": true,
      "stock": 45
    },
    {
      "id": "elem-002",
      "nom": "Sensor ultrasònic HC-SR04",
      "descripcio": "Sensor de distància per mesura d'obstacles",
      "categoria": "Sensors",
      "preu": 3.50,
      "imatge": "https://via.placeholder.com/300x200?text=Sensor",
      "popular": true,
      "stock": 120
    },
    {
      "id": "elem-003",
      "nom": "Motor pas a pas NEMA 17",
      "descripcio": "Motor de precisió per projectes de robòtica",
      "categoria": "Motors",
      "preu": 18.75,
      "imatge": "https://via.placeholder.com/300x200?text=Motor",
      "popular": true,
      "stock": 32
    },
    {
      "id": "elem-004",
      "nom": "Pantalla LCD 16x2",
      "descripcio": "Pantalla de text amb retroil·luminació blava",
      "categoria": "Displays",
      "preu": 8.99,
      "imatge": "https://via.placeholder.com/300x200?text=LCD",
      "popular": false,
      "stock": 67
    },
    {
      "id": "elem-005",
      "nom": "Mòdul Bluetooth HC-05",
      "descripcio": "Comunicació sense fils per Arduino i Raspberry Pi",
      "categoria": "Communication",
      "preu": 6.25,
      "imatge": "https://via.placeholder.com/300x200?text=Bluetooth",
      "popular": true,
      "stock": 89
    }
  ]
}{% endcapture %}
{% include code-block.html lang="json" code=code_004 %}

  <p>Aquest JSON simula una resposta d'API real amb 5 elements del catàleg.</p>

  <h3>3.3. Instal·lar i arrencar json-server</h3>

{% capture code_005 %}npm install -g json-server
json-server --watch tools/api/cataleg.json --port 4301 --delay 600{% endcapture %}
{% include code-block.html lang="bash" code=code_005 %}

  <p><strong>Paràmetres clau:</strong></p>

  <ul>
    <li><code>--port 4301</code> — Evita conflictes amb Angular (port 4200)</li>
    <li><code>--delay 600</code> — Simula latència de xarxa (600ms) per provar indicadors de càrrega</li>
  </ul>

  <p><strong>Verificació:</strong> Obriu <code>http://localhost:4301/elements</code> al navegador i hauríeu de veure l'array JSON amb els 5 elements.</p>

  <h3>3.4. Configurar variables d'entorn</h3>

  <p>Creeu un fitxer per gestionar la configuració de l'API:</p>

{% capture code_006 %}touch src/environments/environment.development.ts
code src/environments/environment.development.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_006 %}

  <p>Fitxer <code>src/environments/environment.development.ts</code>:</p>

{% capture code_007 %}export const environment = {
  production: false,
  apiUrl: 'http://localhost:4301',
  apiDelay: 600
};{% endcapture %}
{% include code-block.html lang="typescript" code=code_007 %}

  <p>Separar la configuració de l'API permet canviar fàcilment entre mock local i API real sense modificar el codi dels serveis.</p>

  <h3>3.5. Documentar la configuració</h3>

  <p>Actualitzeu <code>docs/serveis.md</code> amb la documentació completa:</p>

{% capture code_008 %}# Configuració de serveis

## API Mock (desenvolupament)

### Arrencar el servidor

```bash
json-server --watch tools/api/cataleg.json --port 4301 --delay 600
```

### Endpoints disponibles

- `GET /elements` - Retorna tots els elements
- `GET /elements?popular=true` - Filtra elements populars
- `GET /elements?q=Arduino` - Cerca elements per nom
- `GET /elements/:id` - Obté un element per ID

### Configuració

- **Port:** 4301
- **Latència simulada:** 600ms
- **Fitxer de dades:** `tools/api/cataleg.json`

## Canviar a API real

Per utilitzar una API real, modifiqueu `src/environments/environment.development.ts`:

```typescript
export const environment = {
  production: false,
  apiUrl: 'https://api.exemple.com',
  apiKey: 'LA_VOSTRA_CLAU_API' // Si cal autenticació
};
```{% endcapture %}
{% include code-block.html lang="markdown" code=code_008 %}

  <h3>3.6. Troubleshooting</h3>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Error</th>
        <th>Causa</th>
        <th>Solució</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>json-server: command not found</code></td>
        <td>json-server no instal·lat globalment</td>
        <td>Executar <code>npm install -g json-server</code> i reiniciar terminal</td>
      </tr>
      <tr>
        <td><code>EADDRINUSE: port 4301 already in use</code></td>
        <td>Port ja ocupat per un altre procés</td>
        <td>Linux/macOS: <code>lsof -ti:4301 | xargs kill -9</code></td>
      </tr>
      <tr>
        <td><code>ENOENT: no such file or directory</code></td>
        <td>Ruta incorrecta o fitxer no existeix</td>
        <td>Verificar ruta amb <code>pwd</code> i comprovar que <code>cataleg.json</code> existeix</td>
      </tr>
      <tr>
        <td><code>Cannot GET /elements</code> al navegador</td>
        <td>json-server no està actiu</td>
        <td>Comprovar que la terminal mostra "Resources" amb /elements</td>
      </tr>
      <tr>
        <td>Navegador mostra dades massa ràpid</td>
        <td>Falta paràmetre --delay</td>
        <td>Afegir <code>--delay 600</code> a la comanda json-server</td>
      </tr>
    </tbody>
  </table>

  <h3>3.7. Checkpoint</h3>

  {% include checklist.html elements="He creat el fitxer <code>cataleg.json</code> amb 5 elements de mostra|Veig un array JSON amb 5 elements al navegador a <code>http://localhost:4301/elements</code>|El servidor mock respon amb un retard observable (~600ms)|He creat el fitxer d'entorn amb la URL de l'API mock|He documentat la configuració de l'API a <code>docs/serveis.md</code>" %}

</div>

<!-- SECCIÓ 4: Models i adaptadors -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio4">
  <h2 id="Unitat3_Bloc4_Seccio4">4. Models i adaptadors</h2>

  <div class="info_box">
    <p><strong>Objectiu:</strong> Crear interfícies TypeScript per modelar les dades i adaptadors per transformar respostes de l'API.</p>
    <p><strong>Integra conceptes de:</strong> Lectura 3.2.1 (Definició de models amb interfícies), Lectura 3.2.2 (Adaptadors i transformació de dades externes).</p>
  </div>

  <h3>4.1. Crear interfície del model Element</h3>

  <p>Crearem les interfícies per modelar els elements del catàleg. Separarem el model intern de l'aplicació del model de resposta de l'API:</p>

{% capture code_009 %}mkdir -p src/app/models
touch src/app/models/element.model.ts
code src/app/models/element.model.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_009 %}

  <p>Fitxer <code>src/app/models/element.model.ts</code>:</p>

{% capture code_010 %}export interface ElementCataleg {
  id: string;
  nom: string;
  descripcio: string;
  categoria: string;
  preu: number;
  imatge: string;
  esPopular: boolean;
  stock: number;
  dataAfegit?: Date;
}

export interface ElementApiResponse {
  id: string;
  nom: string;
  descripcio: string;
  categoria: string;
  preu: number;
  imatge: string;
  popular: boolean;  // ← Diferent nom que el model intern
  stock: number;
}

export interface ElementsCercaResponse {
  elements: ElementApiResponse[];
  total: number;
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_010 %}

  <p><strong>Per què separar models?</strong> Aquesta separació permet adaptar noms (popular → esPopular), afegir camps calculats (dataAfegit) i protegir l'aplicació davant canvis a l'API.</p>

  <h3>4.2. Crear adaptador de transformació</h3>

  <p>Crearem funcions pures que transformen les dades de l'API al format intern:</p>

{% capture code_011 %}mkdir -p src/app/adaptadors
touch src/app/adaptadors/element.adaptador.ts
code src/app/adaptadors/element.adaptador.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_011 %}

  <p>Fitxer <code>src/app/adaptadors/element.adaptador.ts</code>:</p>

{% capture code_012 %}import { ElementCataleg, ElementApiResponse } from '../models/element.model';

export function adaptarElementApi(apiElement: ElementApiResponse): ElementCataleg {
  return {
    id: apiElement.id,
    nom: apiElement.nom,
    descripcio: apiElement.descripcio,
    categoria: apiElement.categoria,
    preu: apiElement.preu,
    imatge: apiElement.imatge,
    esPopular: apiElement.popular,  // Canvi de nom
    stock: apiElement.stock,
    dataAfegit: new Date()  // Camp afegit
  };
}

export function adaptarElementsApi(apiElements: ElementApiResponse[]): ElementCataleg[] {
  return apiElements.map(adaptarElementApi);
}

export function elementBuit(): ElementCataleg {
  return {
    id: '',
    nom: '',
    descripcio: '',
    categoria: '',
    preu: 0,
    imatge: 'https://via.placeholder.com/300x200?text=Sense+imatge',
    esPopular: false,
    stock: 0,
    dataAfegit: new Date()
  };
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_012 %}

  <p><strong>Avantatges dels adaptadors com a funcions pures:</strong> Faciliten les proves unitàries i la reutilització.</p>

  <h3>4.3. Crear interfícies d'estat del servei</h3>

  <p>Afegiu al final del fitxer <code>element.model.ts</code> les interfícies per gestionar l'estat:</p>

{% capture code_013 %}export type EstatServei = 'inicial' | 'carregant' | 'exit' | 'error';

export interface EstatElements {
  estat: EstatServei;
  elements: ElementCataleg[];
  error?: string;
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_013 %}

  <p>Aquestes interfícies permeten gestionar de forma estructurada els estats de càrrega, errors i llistes d'elements.</p>

  <h3>4.4. Provar l'adaptador amb dades mock</h3>

  <p>Creeu un fitxer temporal per provar els adaptadors:</p>

{% capture code_014 %}touch src/app/adaptadors/element.adaptador.test.ts
code src/app/adaptadors/element.adaptador.test.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_014 %}

  <p>Fitxer <code>element.adaptador.test.ts</code>:</p>

{% capture code_015 %}import { adaptarElementApi, adaptarElementsApi } from './element.adaptador';
import { ElementApiResponse } from '../models/element.model';

const mockApiElement: ElementApiResponse = {
  id: 'test-001',
  nom: 'Element de prova',
  descripcio: 'Descripció de prova',
  categoria: 'Test',
  preu: 10.50,
  imatge: 'https://exemple.com/test.jpg',
  popular: true,
  stock: 25
};

const elementAdaptat = adaptarElementApi(mockApiElement);
console.log('Element adaptat:', elementAdaptat);
console.log('Camp esPopular:', elementAdaptat.esPopular);
console.log('Camp dataAfegit:', elementAdaptat.dataAfegit);

const mockApiElements = [mockApiElement, { ...mockApiElement, id: 'test-002' }];
const elementsAdaptats = adaptarElementsApi(mockApiElements);
console.log('Elements adaptats:', elementsAdaptats.length);{% endcapture %}
{% include code-block.html lang="typescript" code=code_015 %}

  <p>Executeu el test:</p>

{% capture code_016 %}npx ts-node src/app/adaptadors/element.adaptador.test.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_016 %}

  <p><strong>Resultat esperat:</strong> Veieu l'element adaptat amb <code>esPopular: true</code> i <code>dataAfegit</code> amb la data actual. Després, esborreu el fitxer de test.</p>

  <h3>4.5. Documentar models i adaptadors</h3>

  <p>Actualitzeu <code>docs/models.md</code> amb la documentació completa:</p>

{% capture code_017 %}# Models i adaptadors

## Interfícies principals

### ElementCataleg (model intern)

Model utilitzat dins l'aplicació Angular:

```typescript
interface ElementCataleg {
  id: string;
  nom: string;
  descripcio: string;
  categoria: string;
  preu: number;
  imatge: string;
  esPopular: boolean;    // ← Convenció camelCase
  stock: number;
  dataAfegit?: Date;     // ← Camp afegit
}
```

### ElementApiResponse (resposta API)

Format de les dades que retorna l'API:

```typescript
interface ElementApiResponse {
  id: string;
  nom: string;
  descripcio: string;
  categoria: string;
  preu: number;
  imatge: string;
  popular: boolean;      // ← Nom diferent
  stock: number;
}
```

## Adaptadors

### adaptarElementApi()

Transforma un element de l'API al format intern:

- Canvia `popular` → `esPopular`
- Afegeix `dataAfegit` amb data actual
- Manté la resta de camps

### adaptarElementsApi()

Aplica `adaptarElementApi()` a un array d'elements.

### elementBuit()

Retorna un element amb valors per defecte per inicialitzar formularis.

## Mapeig de camps

| Camp API | Camp intern | Transformació |
|----------|-------------|---------------|
| `id` | `id` | Cap |
| `nom` | `nom` | Cap |
| `descripcio` | `descripcio` | Cap |
| `categoria` | `categoria` | Cap |
| `preu` | `preu` | Cap |
| `imatge` | `imatge` | Cap |
| `popular` | `esPopular` | Renombrat |
| `stock` | `stock` | Cap |
| — | `dataAfegit` | Afegit (Date actual) |{% endcapture %}
{% include code-block.html lang="markdown" code=code_017 %}

  <h3>4.6. Troubleshooting</h3>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Error</th>
        <th>Causa</th>
        <th>Solució</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>Cannot find module './models/element.model'</code></td>
        <td>Ruta d'importació incorrecta</td>
        <td>Verificar que la ruta és relativa: <code>'../models/element.model'</code></td>
      </tr>
      <tr>
        <td><code>Property 'esPopular' does not exist on type...</code></td>
        <td>Interfície no definida correctament</td>
        <td>Comprovar que <code>ElementCataleg</code> té <code>esPopular: boolean</code></td>
      </tr>
      <tr>
        <td><code>Type 'Date' is not assignable to type 'undefined'</code></td>
        <td>Camp opcional mal definit</td>
        <td>Afegir <code>?</code> al camp: <code>dataAfegit?: Date</code></td>
      </tr>
      <tr>
        <td><code>Cannot read property 'map' of undefined</code></td>
        <td>Array no inicialitzat</td>
        <td>Afegir comprovació: <code>if (!apiElements) return []</code></td>
      </tr>
      <tr>
        <td>Tests d'adaptador fallen</td>
        <td>Dades mock incorrectes</td>
        <td>Verificar que mockApiElement té tots els camps requerits</td>
      </tr>
    </tbody>
  </table>

  <h3>4.7. Checkpoint</h3>

  {% include checklist.html elements="He creat les interfícies <code>ElementCataleg</code>, <code>ElementApiResponse</code> i <code>ElementsCercaResponse</code>|He creat les funcions <code>adaptarElementApi</code>, <code>adaptarElementsApi</code> i <code>elementBuit</code>|He afegit <code>EstatServei</code> i <code>EstatElements</code> al model|He provat l'adaptador i funciona correctament|He esborrat el fitxer de test temporal després de la verificació|He documentat models i adaptadors a <code>docs/models.md</code>" %}

</div>

<!-- SECCIÓ 5: Servei HTTP i gestió d'estats -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio5">
  <h2 id="Unitat3_Bloc4_Seccio5">5. Servei HTTP i gestió d'estats</h2>

  <div class="info_box">
    <p><strong>Objectiu:</strong> Crear un servei Angular amb HttpClient que gestiona estats de càrrega, èxit i error utilitzant signals.</p>
    <p><strong>Integra conceptes de:</strong> Lectura 3.1.1 (Creació de serveis i separació de responsabilitats), Lectura 3.1.2 (Client de peticions i comunicació amb serveis web), Lectura 3.1.3 (Gestió d'errors i estats de càrrega).</p>
  </div>

  <h3>5.1. Crear servei ElementService</h3>

  <p><strong>PowerShell (Windows):</strong></p>

{% capture code_018 %}ng generate service serveis/element --skip-tests
code src\app\serveis\element.service.ts{% endcapture %}
{% include code-block.html lang="powershell" code=code_018 %}

  <p><strong>bash/zsh (macOS/Linux):</strong></p>

{% capture code_019 %}ng generate service serveis/element --skip-tests
code src/app/serveis/element.service.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_019 %}

  <h3>5.2. Implementar servei amb signals i HttpClient</h3>

  <p>Substituïu tot el contingut de <code>element.service.ts</code>:</p>

{% capture code_020 %}import { Injectable, signal } from '@angular/core';
import { HttpClient, HttpErrorResponse } from '@angular/common/http';
import { catchError, map, tap } from 'rxjs/operators';
import { of } from 'rxjs';

import { ElementCataleg, ElementApiResponse, EstatServei } from '../models/element.model';
import { adaptarElementsApi } from '../adaptadors/element.adaptador';
import { environment } from '../../environments/environment.development';

@Injectable({
  providedIn: 'root'
})
export class ElementService {
  // Signals per gestionar l'estat de forma reactiva
  private readonly elementsSignal = signal<ElementCataleg[]>([]);
  private readonly estatSignal = signal<EstatServei>('inicial');
  private readonly errorSignal = signal<string>('');

  // Exposem signals com a només lectura
  readonly elements = this.elementsSignal.asReadonly();
  readonly estat = this.estatSignal.asReadonly();
  readonly error = this.errorSignal.asReadonly();

  private readonly apiUrl = environment.apiUrl;

  constructor(private http: HttpClient) {}

  /**
   * Obté els elements populars del catàleg
   */
  obtenirPopulars(): void {
    this.estatSignal.set('carregant');
    this.errorSignal.set('');

    this.http.get<ElementApiResponse[]>(`${this.apiUrl}/elements?popular=true`)
      .pipe(
        map(adaptarElementsApi),
        tap(elements => {
          this.elementsSignal.set(elements);
          this.estatSignal.set('exit');
        }),
        catchError((error: HttpErrorResponse) => {
          const missatgeError = this.gestionarError(error);
          this.errorSignal.set(missatgeError);
          this.estatSignal.set('error');
          this.elementsSignal.set([]);
          return of([]);
        })
      )
      .subscribe();
  }

  /**
   * Cerca elements per terme de cerca
   */
  cercar(terme: string): void {
    if (!terme.trim()) {
      this.obtenirPopulars();
      return;
    }

    this.estatSignal.set('carregant');
    this.errorSignal.set('');

    this.http.get<ElementApiResponse[]>(`${this.apiUrl}/elements?q=${terme}`)
      .pipe(
        map(adaptarElementsApi),
        tap(elements => {
          this.elementsSignal.set(elements);
          this.estatSignal.set('exit');
        }),
        catchError((error: HttpErrorResponse) => {
          const missatgeError = this.gestionarError(error);
          this.errorSignal.set(missatgeError);
          this.estatSignal.set('error');
          this.elementsSignal.set([]);
          return of([]);
        })
      )
      .subscribe();
  }

  /**
   * Comprova si un codi d'element està disponible (per validació asíncrona)
   */
  codiDisponible(codi: string): Promise<boolean> {
    return new Promise((resolve) => {
      setTimeout(() => {
        this.http.get<ElementApiResponse[]>(`${this.apiUrl}/elements?id=${codi}`)
          .subscribe({
            next: (elements) => resolve(elements.length === 0),
            error: () => resolve(false)
          });
      }, 500);  // Simula latència de validació
    });
  }

  /**
   * Reinicia l'estat del servei
   */
  reiniciar(): void {
    this.elementsSignal.set([]);
    this.estatSignal.set('inicial');
    this.errorSignal.set('');
  }

  /**
   * Gestiona errors HTTP i retorna missatges comprensibles
   */
  private gestionarError(error: HttpErrorResponse): string {
    if (error.error instanceof ErrorEvent) {
      // Error de client o xarxa
      return `Error de xarxa: ${error.error.message}`;
    }

    // Error del servidor
    switch (error.status) {
      case 0:
        return 'No es pot connectar al servidor. Comprova que json-server està actiu.';
      case 404:
        return 'Endpoint no trobat. Verifica la URL de l\'API.';
      case 500:
        return 'Error intern del servidor.';
      default:
        return `Error desconegut (${error.status}): ${error.message}`;
    }
  }
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_020 %}

  <p><strong>Context:</strong> Aquest servei implementa:</p>
  <ul>
    <li><strong>Signals</strong> per gestió d'estat reactiu (Angular 16+)</li>
    <li><strong>Separació de responsabilitats:</strong> El servei només gestiona HTTP, l'adaptació és a l'adaptador</li>
    <li><strong>Gestió d'errors centralitzada</strong> amb missatges comprensibles</li>
    <li><strong>Mètodes per validació asíncrona</strong> (útil per formularis)</li>
  </ul>

  <h3>5.3. Configurar HttpClient a l'aplicació</h3>

  <p>Editeu <code>src/app/app.config.ts</code>:</p>

{% capture code_021 %}import { ApplicationConfig, provideZoneChangeDetection } from '@angular/core';
import { provideRouter } from '@angular/router';
import { provideHttpClient } from '@angular/common/http';

import { routes } from './app.routes';

export const appConfig: ApplicationConfig = {
  providers: [
    provideZoneChangeDetection({ eventCoalescing: true }),
    provideRouter(routes),
    provideHttpClient()  // ← Afegir HttpClient
  ]
};{% endcapture %}
{% include code-block.html lang="typescript" code=code_021 %}

  <h3>5.4. Provar el servei des de la consola del navegador</h3>

  <p>Editeu temporalment <code>app.component.ts</code>:</p>

{% capture code_022 %}import { Component, OnInit } from '@angular/core';
import { ElementService } from './serveis/element.service';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [],
  template: `
    <div>
      <h1>Prova del servei</h1>
      <p>Obre la consola per veure els resultats</p>
    </div>
  `
})
export class AppComponent implements OnInit {
  constructor(private elementService: ElementService) {}

  ngOnInit() {
    console.log('Estat inicial:', this.elementService.estat());

    this.elementService.obtenirPopulars();

    // Espera 1 segon i mostra resultats
    setTimeout(() => {
      console.log('Estat final:', this.elementService.estat());
      console.log('Elements:', this.elementService.elements());
      console.log('Error:', this.elementService.error());
    }, 1500);
  }
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_022 %}

  <p><strong>Verificació:</strong></p>

  <ol>
    <li>Assegureu-vos que <code>json-server</code> està actiu</li>
    <li>Executeu <code>ng serve</code></li>
    <li>Obriu <code>http://localhost:4200</code></li>
    <li>Obriu la consola del navegador (F12)</li>
  </ol>

  <p>Heu de veure:</p>
  <ul>
    <li>Estat inicial: <code>'inicial'</code></li>
    <li>Estat final: <code>'exit'</code></li>
    <li>Elements: Array amb elements populars</li>
    <li>Error: cadena buida <code>''</code></li>
  </ul>

  <p><strong>Prova d'error:</strong></p>

  <ol>
    <li>Atureu <code>json-server</code> (Ctrl+C)</li>
    <li>Recarregueu la pàgina</li>
    <li>Heu de veure:
      <ul>
        <li>Estat final: <code>'error'</code></li>
        <li>Error: "No es pot connectar al servidor..."</li>
      </ul>
    </li>
  </ol>

  <h3>5.5. Documentar el servei</h3>

  <p>Actualitzeu <code>docs/serveis.md</code> afegint:</p>

{% capture code_023 %}## ElementService

### Responsabilitats

- Comunicació HTTP amb l'API de catàleg
- Gestió d'estats (inicial, carregant, èxit, error)
- Transformació de respostes amb adaptadors
- Gestió centralitzada d'errors

### Mètodes públics

#### obtenirPopulars(): void

Carrega elements populars del catàleg.

**Flux:**
1. Canvia estat a `'carregant'`
2. Fa petició GET a `/elements?popular=true`
3. Adapta resposta amb `adaptarElementsApi`
4. Actualitza signals amb dades i estat `'exit'`
5. En cas d'error, actualitza error i estat `'error'`

#### cercar(terme: string): void

Cerca elements per terme de cerca.

**Paràmetres:**
- `terme`: Text a cercar (mínim 1 caràcter)

**Comportament:**
- Si terme buit: carrega populars
- Si terme vàlid: cerca amb `/elements?q={terme}`

#### codiDisponible(codi: string): Promise<boolean>

Comprova si un codi d'element està disponible (no existeix).

**Ús:** Validador asíncron per formularis

**Retorna:** `true` si el codi està disponible, `false` si ja existeix

#### reiniciar(): void

Neteja estat i elements del servei.

### Signals exposades (només lectura)

- `elements()`: Array d'elements actuals
- `estat()`: Estat actual del servei
- `error()`: Missatge d'error (si n'hi ha)

### Gestió d'errors

Errors HTTP es transformen en missatges comprensibles:

| Codi | Missatge |
|------|----------|
| 0 | "No es pot connectar al servidor..." |
| 404 | "Endpoint no trobat..." |
| 500 | "Error intern del servidor" |
| Altres | "Error desconegut (XXX)..." |

### Exemple d'ús

```typescript
constructor(private elementService: ElementService) {}

ngOnInit() {
  // Carregar populars
  this.elementService.obtenirPopulars();

  // Observar estat
  effect(() => {
    console.log('Estat:', this.elementService.estat());
    console.log('Elements:', this.elementService.elements());
  });
}
```{% endcapture %}
{% include code-block.html lang="markdown" code=code_023 %}

  <h3>5.6. Troubleshooting</h3>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Error</th>
        <th>Causa</th>
        <th>Solució</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>NullInjectorError: No provider for HttpClient</code></td>
        <td>HttpClient no configurat</td>
        <td>Afegir <code>provideHttpClient()</code> a <code>app.config.ts</code></td>
      </tr>
      <tr>
        <td><code>Cannot read properties of undefined (reading 'set')</code></td>
        <td>Signal no inicialitzat</td>
        <td>Verificar que signals es defineixen amb <code>signal&lt;T&gt;(valorInicial)</code></td>
      </tr>
      <tr>
        <td><code>ERROR Error: NG0203: inject() must be called...</code></td>
        <td>Servei injectat fora del context</td>
        <td>Moure injecció al constructor, NO a mètodes</td>
      </tr>
      <tr>
        <td>Estat sempre en 'carregant'</td>
        <td>Subscribe no cridat</td>
        <td>Afegir <code>.subscribe()</code> al final del pipe</td>
      </tr>
      <tr>
        <td><code>CORS policy: No 'Access-Control-Allow-Origin' header</code></td>
        <td>json-server no permet CORS</td>
        <td>json-server té CORS activat per defecte, verificar URL</td>
      </tr>
      <tr>
        <td>Adaptador no transforma dades</td>
        <td>map() no aplicat</td>
        <td>Afegir <code>.pipe(map(adaptarElementsApi))</code> abans de tap</td>
      </tr>
      <tr>
        <td>Elements duplicats</td>
        <td>Múltiples crides simultànies</td>
        <td>Implementar debounce o takeUntil per cancel·lar peticions anteriors</td>
      </tr>
      <tr>
        <td><code>Cannot find module '@angular/common/http'</code></td>
        <td>Dependència no instal·lada</td>
        <td>Executar <code>npm install</code> per instal·lar totes les dependències</td>
      </tr>
    </tbody>
  </table>

  <h3>5.7. Checkpoint</h3>

  {% include checklist.html elements="He creat el servei <code>ElementService</code> amb signals|He implementat els mètodes <code>obtenirPopulars()</code>, <code>cercar()</code> i <code>codiDisponible()</code>|He configurat <code>provideHttpClient()</code> a <code>app.config.ts</code>|He provat el servei i funciona correctament amb estats d'èxit i error|He verificat la gestió d'errors centralitzada|He documentat el servei a <code>docs/serveis.md</code>" %}

</div>

<!-- SECCIÓ 6: Llistat reactiu amb estats -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio6">
  <h2 id="Unitat3_Bloc4_Seccio6">6. Llistat reactiu amb estats</h2>

  <div class="info_box">
    <p><strong>Objectiu:</strong> Crear un component de pàgina que mostra un llistat d'elements amb gestió visual dels quatre estats possibles (inicial, carregant, èxit, error).</p>
    <p><strong>Integra conceptes de:</strong> Lectura 3.2.3 (Integració reactiva amb components), Lectura 3.1.3 (Gestió d'errors i estats de càrrega).</p>
  </div>

  <h3>6.1. Crear component CatalegPage</h3>

  <p><strong>PowerShell (Windows):</strong></p>

{% capture code_024 %}ng generate component pages/cataleg-page --standalone --inline-style=false --inline-template=false --skip-tests
code src\app\pages\cataleg-page\cataleg-page.component.ts{% endcapture %}
{% include code-block.html lang="powershell" code=code_024 %}

  <p><strong>bash/zsh (macOS/Linux):</strong></p>

{% capture code_025 %}ng generate component pages/cataleg-page --standalone --inline-style=false --inline-template=false --skip-tests
code src/app/pages/cataleg-page/cataleg-page.component.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_025 %}

  <h3>6.2. Implementar lògica del component</h3>

  <p>Substituïu el contingut de <code>cataleg-page.component.ts</code>:</p>

{% capture code_026 %}import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ElementService } from '../../serveis/element.service';

@Component({
  selector: 'app-cataleg-page',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './cataleg-page.component.html',
  styleUrl: './cataleg-page.component.scss'
})
export class CatalegPageComponent implements OnInit {
  constructor(public elementService: ElementService) {}

  ngOnInit(): void {
    this.elementService.obtenirPopulars();
  }

  reintentar(): void {
    this.elementService.obtenirPopulars();
  }
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_026 %}

  <p><strong>Context:</strong> El component és mínim. Delega tota la lògica al servei i només exposa mètodes per la vista. És un component "contenidor" o "smart component".</p>

  <h3>6.3. Crear plantilla amb gestió d'estats</h3>

  <p>Substituïu el contingut de <code>cataleg-page.component.html</code>:</p>

{% capture code_027 %}{% raw %}<div class="cataleg-page">
  <header class="page-header">
    <h1>Catàleg d'Elements</h1>
    <p class="subtitle">Elements populars del nostre catàleg</p>
  </header>

  <!-- Estat: Carregant -->
  <div class="estat-carregant" *ngIf="elementService.estat() === 'carregant'">
    <div class="spinner"></div>
    <p>Carregant elements...</p>
  </div>

  <!-- Estat: Error -->
  <div class="estat-error" *ngIf="elementService.estat() === 'error'">
    <div class="error-icon">⚠️</div>
    <h2>Error al carregar elements</h2>
    <p class="error-missatge">{{ elementService.error() }}</p>
    <button class="btn-reintentar" (click)="reintentar()">
      Reintentar
    </button>
  </div>

  <!-- Estat: Èxit (elements carregats) -->
  <div class="estat-exit" *ngIf="elementService.estat() === 'exit'">
    <!-- Missatge si no hi ha elements -->
    <div class="sense-resultats" *ngIf="elementService.elements().length === 0">
      <p>No s'han trobat elements populars</p>
    </div>

    <!-- Llistat d'elements -->
    <div class="elements-grid" *ngIf="elementService.elements().length > 0">
      <div class="element-card" *ngFor="let element of elementService.elements()">
        <img [src]="element.imatge" [alt]="element.nom" class="element-imatge">
        <div class="element-info">
          <h3 class="element-nom">{{ element.nom }}</h3>
          <p class="element-categoria">{{ element.categoria }}</p>
          <p class="element-descripcio">{{ element.descripcio }}</p>
          <div class="element-footer">
            <span class="element-preu">{{ element.preu | number:'1.2-2' }}€</span>
            <span class="element-stock" [class.baix-stock]="element.stock < 20">
              Stock: {{ element.stock }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Estat: Inicial (no s'ha carregat res encara) -->
  <div class="estat-inicial" *ngIf="elementService.estat() === 'inicial'">
    <p>Inicialitzant...</p>
  </div>
</div>{% endraw %}{% endcapture %}
{% include code-block.html lang="html" code=code_027 %}

  <p><strong>Context:</strong> La plantilla mostra diferents vistes segons l'estat del servei:</p>
  <ul>
    <li><strong>Carregant:</strong> Spinner animat</li>
    <li><strong>Error:</strong> Missatge amb botó de reintent</li>
    <li><strong>Èxit:</strong> Grid d'elements</li>
    <li><strong>Inicial:</strong> Missatge temporal</li>
  </ul>

  <h3>6.4. Afegir estils al component</h3>

  <p>Substituïu el contingut de <code>cataleg-page.component.scss</code>:</p>

{% capture code_028 %}.cataleg-page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.page-header {
  margin-bottom: 2rem;

  h1 {
    margin: 0 0 0.5rem;
    color: #333;
  }

  .subtitle {
    margin: 0;
    color: #666;
    font-size: 1.1rem;
  }
}

// Estat: Carregant
.estat-carregant {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 4rem 0;

  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  p {
    margin-top: 1rem;
    color: #666;
  }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

// Estat: Error
.estat-error {
  background-color: #fee;
  border: 2px solid #e74c3c;
  border-radius: 8px;
  padding: 2rem;
  text-align: center;
  margin: 2rem 0;

  .error-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  h2 {
    margin: 0 0 1rem;
    color: #c0392b;
  }

  .error-missatge {
    margin: 0 0 1.5rem;
    color: #666;
    font-size: 1rem;
  }

  .btn-reintentar {
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s;

    &:hover {
      background-color: #c0392b;
    }
  }
}

// Estat: Èxit
.sense-resultats {
  text-align: center;
  padding: 3rem;
  color: #666;
  font-size: 1.1rem;
}

.elements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.5rem;
}

.element-card {
  background-color: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  overflow: hidden;
  transition: transform 0.3s, box-shadow 0.3s;

  &:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .element-imatge {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .element-info {
    padding: 1rem;

    .element-nom {
      margin: 0 0 0.5rem;
      font-size: 1.2rem;
      color: #333;
    }

    .element-categoria {
      margin: 0 0 0.75rem;
      font-size: 0.9rem;
      color: #3498db;
      font-weight: 600;
    }

    .element-descripcio {
      margin: 0 0 1rem;
      color: #666;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .element-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 0.75rem;
      border-top: 1px solid #eee;

      .element-preu {
        font-size: 1.3rem;
        font-weight: bold;
        color: #27ae60;
      }

      .element-stock {
        font-size: 0.9rem;
        color: #666;
        padding: 0.25rem 0.5rem;
        background-color: #ecf0f1;
        border-radius: 4px;

        &.baix-stock {
          background-color: #ffe6e6;
          color: #e74c3c;
        }
      }
    }
  }
}

// Estat: Inicial
.estat-inicial {
  text-align: center;
  padding: 3rem;
  color: #999;
  font-style: italic;
}{% endcapture %}
{% include code-block.html lang="scss" code=code_028 %}

  <h3>6.5. Integrar component a l'aplicació</h3>

  <p>Editeu <code>app.component.ts</code>:</p>

{% capture code_029 %}import { Component } from '@angular/core';
import { CatalegPageComponent } from './pages/cataleg-page/cataleg-page.component';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CatalegPageComponent],
  template: `<app-cataleg-page />`,
  styles: [`
    :host {
      display: block;
      min-height: 100vh;
      background-color: #f5f5f5;
    }
  `]
})
export class AppComponent {}{% endcapture %}
{% include code-block.html lang="typescript" code=code_029 %}

  <h3>6.6. Provar els diferents estats</h3>

  <p><strong>Verificació 1: Estat de càrrega</strong></p>

  <ol>
    <li>Assegureu-vos que json-server està actiu amb delay 600ms</li>
    <li>Executeu <code>ng serve</code></li>
    <li>Obriu <code>http://localhost:4200</code></li>
    <li>Heu de veure breument el spinner de càrrega</li>
  </ol>

  <p><strong>Verificació 2: Estat d'èxit</strong></p>

  <ol>
    <li>Després del spinner, heu de veure una graella amb elements</li>
    <li>Cada targeta mostra: imatge, nom, categoria, descripció, preu i stock</li>
    <li>Elements amb stock &lt; 20 mostren l'indicador en vermell</li>
  </ol>

  <p><strong>Verificació 3: Estat d'error</strong></p>

  <ol>
    <li>Atureu json-server (Ctrl+C a la terminal)</li>
    <li>Recarregueu la pàgina</li>
    <li>Heu de veure el missatge d'error amb botó "Reintentar"</li>
    <li>El missatge ha de ser: "No es pot connectar al servidor. Comprova que json-server està actiu."</li>
  </ol>

  <p><strong>Verificació 4: Reintent després d'error</strong></p>

  <ol>
    <li>Torneu a arrencar json-server</li>
    <li>Feu clic al botó "Reintentar"</li>
    <li>Heu de veure el spinner breument</li>
    <li>Després, els elements es carreguen correctament</li>
  </ol>

  <h3>6.7. Troubleshooting</h3>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Error</th>
        <th>Causa</th>
        <th>Solució</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>Can't bind to 'ngIf' since it isn't a known property</code></td>
        <td>CommonModule no importat</td>
        <td>Afegir <code>CommonModule</code> a imports del component</td>
      </tr>
      <tr>
        <td>Elements no es mostren</td>
        <td>estat() no és 'exit'</td>
        <td>Verificar a consola el valor de <code>elementService.estat()</code></td>
      </tr>
      <tr>
        <td>Spinner no desapareix</td>
        <td>Subscribe no finalitza</td>
        <td>Verificar que tap() actualitza estat a 'exit'</td>
      </tr>
      <tr>
        <td>Estils no s'apliquen</td>
        <td>Fitxer SCSS no enllaçat</td>
        <td>Verificar <code>styleUrl</code> al decorador del component</td>
      </tr>
      <tr>
        <td>Pipe 'number' no funciona</td>
        <td>CommonModule no importat</td>
        <td>Afegir <code>CommonModule</code> a imports del component</td>
      </tr>
      <tr>
        <td>Imatges no es carreguen</td>
        <td>URLs placeholder invàlides</td>
        <td>Verificar que les URLs són accessibles</td>
      </tr>
    </tbody>
  </table>

  <h3>6.8. Checkpoint</h3>

  {% include checklist.html elements="He creat el component <code>CatalegPageComponent</code>|He implementat la plantilla amb gestió dels 4 estats (inicial, carregant, exit, error)|He afegit estils responsius amb indicadors visuals|He integrat el component a l'aplicació|He provat l'estat de càrrega (spinner visible)|He provat l'estat d'èxit (graella d'elements)|He provat l'estat d'error (missatge amb botó reintentar)|El botó reintentar funciona correctament" %}

</div>

<!-- SECCIÓ 7: Formulari de cerca amb validació asíncrona -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio7">
  <h2 id="Unitat3_Bloc4_Seccio7">7. Formulari de cerca amb validació asíncrona</h2>

  <div class="info_box">
    <p><strong>Objectiu:</strong> Crear un formulari reactiu de cerca amb validació asíncrona i debounce per evitar cerques excessives.</p>
    <p><strong>Integra conceptes de:</strong> Lectura 3.3.1 (Formularis reactius: grups i controls), Lectura 3.3.2 (Validacions personalitzades i asíncrones).</p>
  </div>

  <h3>7.1. Crear validador asíncron</h3>

  <p><strong>PowerShell (Windows):</strong></p>

{% capture code_030 %}New-Item -Path "src\app\validadors" -ItemType Directory -Force
New-Item -Path "src\app\validadors\codi-disponible.validator.ts" -ItemType File
code src\app\validadors\codi-disponible.validator.ts{% endcapture %}
{% include code-block.html lang="powershell" code=code_030 %}

  <p><strong>bash/zsh (macOS/Linux):</strong></p>

{% capture code_031 %}mkdir -p src/app/validadors
touch src/app/validadors/codi-disponible.validator.ts
code src/app/validadors/codi-disponible.validator.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_031 %}

  <p>Afegiu el següent codi:</p>

{% capture code_032 %}import { AbstractControl, AsyncValidatorFn, ValidationErrors } from '@angular/forms';
import { Observable, of } from 'rxjs';
import { map, delay } from 'rxjs/operators';
import { ElementService } from '../serveis/element.service';

/**
 * Validador asíncron que comprova si un codi d'element està disponible
 */
export function codiDisponibleValidator(elementService: ElementService): AsyncValidatorFn {
  return (control: AbstractControl): Observable<ValidationErrors | null> => {
    if (!control.value) {
      return of(null);
    }

    return of(control.value).pipe(
      delay(500),  // Simula latència de xarxa
      map(async (codi: string) => {
        const disponible = await elementService.codiDisponible(codi);
        return disponible ? null : { codiNoDisponible: { value: codi } };
      })
    ) as Observable<ValidationErrors | null>;
  };
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_032 %}

  <p><strong>Context:</strong> Aquest validador asíncron comprova si un codi ja existeix a l'API. El delay simula latència real i permet mostrar indicadors de "comprovant...".</p>

  <h3>7.2. Crear component de cerca</h3>

  <p><strong>PowerShell (Windows):</strong></p>

{% capture code_033 %}ng generate component components/formulari-cerca --standalone --inline-style=false --inline-template=false --skip-tests
code src\app\components\formulari-cerca\formulari-cerca.component.ts{% endcapture %}
{% include code-block.html lang="powershell" code=code_033 %}

  <p><strong>bash/zsh (macOS/Linux):</strong></p>

{% capture code_034 %}ng generate component components/formulari-cerca --standalone --inline-style=false --inline-template=false --skip-tests
code src/app/components/formulari-cerca/formulari-cerca.component.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_034 %}

  <h3>7.3. Implementar formulari reactiu</h3>

  <p>Substituïu el contingut de <code>formulari-cerca.component.ts</code>:</p>


{% capture code_035 %}import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
import { ElementService } from '../../serveis/element.service';
import { codiDisponibleValidator } from '../../validadors/codi-disponible.validator';
import { debounceTime } from 'rxjs/operators';

@Component({
  selector: 'app-formulari-cerca',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './formulari-cerca.component.html',
  styleUrl: './formulari-cerca.component.scss'
})
export class FormulariCercaComponent implements OnInit {
  formulariCerca!: FormGroup;

  constructor(
    private fb: FormBuilder,
    private elementService: ElementService
  ) {}

  ngOnInit(): void {
    this.formulariCerca = this.fb.group({
      terme: ['', [
        Validators.minLength(3)
      ]]
    });

    // Cerca automàtica amb debounce
    this.formulariCerca.get('terme')?.valueChanges
      .pipe(debounceTime(500))
      .subscribe(terme => {
        if (this.formulariCerca.get('terme')?.valid) {
          this.cercar();
        }
      });
  }

  cercar(): void {
    const terme = this.formulariCerca.get('terme')?.value;
    this.elementService.cercar(terme);
  }

  netejar(): void {
    this.formulariCerca.reset();
    this.elementService.obtenirPopulars();
  }

  get estaCarregant(): boolean {
    return this.elementService.estat() === 'carregant';
  }

  get termeInvalid(): boolean {
    const control = this.formulariCerca.get('terme');
    return !!(control?.invalid && control?.touched);
  }

  get missatgeError(): string {
    const control = this.formulariCerca.get('terme');
    if (control?.hasError('minlength')) {
      return 'Mínim 3 caràcters';
    }
    return '';
  }
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_035 %}

  <p><strong>Context:</strong> El formulari implementa:</p>
  <ul>
    <li>Cerca automàtica amb <code>debounceTime</code> (espera 500ms després de l'última tecla)</li>
    <li>Validació de longitud mínima (3 caràcters)</li>
    <li>Gestió d'estats de càrrega</li>
  </ul>

  <h3>7.4. Crear plantilla del formulari</h3>

  <p>Substituïu el contingut de <code>formulari-cerca.component.html</code>:</p>

{% capture code_036 %}{% raw %}<div class="formulari-cerca">
  <form [formGroup]="formulariCerca" (ngSubmit)="cercar()">
    <div class="camp-cerca">
      <input type="text" formControlName="terme" placeholder="Cerca elements per nom..." class="input-cerca" [class.invalid]="termeInvalid">
      <div class="indicadors">
        <span class="spinner-petit" *ngIf="estaCarregant"></span>
        <button type="button" class="btn-netejar" (click)="netejar()" *ngIf="formulariCerca.get('terme')?.value">✕</button>
      </div>
    </div>
    <div class="missatge-error" *ngIf="termeInvalid">{{ missatgeError }}</div>
    <div class="accions">
      <button type="submit" class="btn-cercar" [disabled]="formulariCerca.invalid || estaCarregant">Cercar</button>
    </div>
  </form>
</div>{% endraw %}{% endcapture %}
{% include code-block.html lang="html" code=code_036 %}

  <h3>7.5. Afegir estils al formulari</h3>

  <p>Substituïu el contingut de <code>formulari-cerca.component.scss</code>:</p>

{% capture code_037 %}.formulari-cerca {
  background-color: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  margin-bottom: 2rem;

  form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .camp-cerca {
    position: relative;
    display: flex;
    align-items: center;

    .input-cerca {
      flex: 1;
      padding: 0.75rem 3rem 0.75rem 1rem;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      transition: border-color 0.3s;

      &:focus {
        outline: none;
        border-color: #3498db;
      }

      &.invalid {
        border-color: #e74c3c;
      }
    }

    .indicadors {
      position: absolute;
      right: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;

      .spinner-petit {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .btn-netejar {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.3s;

        &:hover {
          color: #e74c3c;
        }
      }
    }
  }

  .missatge-error {
    color: #e74c3c;
    font-size: 0.9rem;
    margin-top: -0.5rem;
  }

  .accions {
    display: flex;
    gap: 1rem;

    .btn-cercar {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;

      &:hover:not(:disabled) {
        background-color: #2980b9;
      }

      &:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }
    }
  }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}{% endcapture %}
{% include code-block.html lang="scss" code=code_037 %}

  <h3>7.6. Integrar formulari al CatalegPage</h3>

  <p>Editeu <code>cataleg-page.component.ts</code>:</p>

{% capture code_038 %}import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ElementService } from '../../serveis/element.service';
import { FormulariCercaComponent } from '../../components/formulari-cerca/formulari-cerca.component';

@Component({
  selector: 'app-cataleg-page',
  standalone: true,
  imports: [CommonModule, FormulariCercaComponent],  // ← Afegir import
  templateUrl: './cataleg-page.component.html',
  styleUrl: './cataleg-page.component.scss'
})
export class CatalegPageComponent implements OnInit {
  constructor(public elementService: ElementService) {}

  ngOnInit(): void {
    this.elementService.obtenirPopulars();
  }

  reintentar(): void {
    this.elementService.obtenirPopulars();
  }
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_038 %}

  <p>Actualitzeu <code>cataleg-page.component.html</code> afegint el formulari després del header:</p>

{% capture code_039 %}{% raw %}<div class="cataleg-page">
  <header class="page-header">
    <h1>Catàleg d'Elements</h1>
    <p class="subtitle">Elements populars del nostre catàleg</p>
  </header>

  <!-- AFEGIR FORMULARI AQUÍ -->
  <app-formulari-cerca />

  <!-- Resta del contingut... -->{% endraw %}{% endcapture %}
{% include code-block.html lang="html" code=code_039 %}

  <h3>7.7. Provar el formulari de cerca</h3>

  <p><strong>Verificació 1: Validació de longitud</strong></p>
  <ol>
    <li>Escriviu "Ar" (2 caràcters)</li>
    <li>Heu de veure el missatge "Mínim 3 caràcters"</li>
    <li>El botó "Cercar" està deshabilitat</li>
  </ol>

  <p><strong>Verificació 2: Cerca automàtica</strong></p>
  <ol>
    <li>Escriviu "Arduino" (més de 3 caràcters)</li>
    <li>Espereu 500ms sense escriure més</li>
    <li>Heu de veure el spinner petit a la dreta de l'input</li>
    <li>Després, els resultats es filtren automàticament</li>
  </ol>

  <p><strong>Verificació 3: Botó de netejar</strong></p>
  <ol>
    <li>Amb text a l'input, heu de veure una "✕" a la dreta</li>
    <li>Feu clic a la "✕"</li>
    <li>L'input es buida i es tornen a carregar els populars</li>
  </ol>

  <h3>7.8. Documentar formularis</h3>

  <p>Actualitzeu <code>docs/formularis.md</code>:</p>

{% capture code_040 %}# Formularis

## FormulariCercaComponent

### Funcionalitat

Formulari reactiu per cercar elements del catàleg amb validació de longitud mínima i cerca automàtica amb debounce.

### Validacions

| Camp | Validació | Missatge d'error |
|------|-----------|------------------|
| terme | `minLength(3)` | "Mínim 3 caràcters" |

### Comportament

- **Cerca automàtica:** Després de 500ms sense escriure, cerca automàticament
- **Debounce:** Evita cerques excessives mentre l'usuari escriu
- **Indicador de càrrega:** Spinner petit mentre cerca
- **Botó netejar:** Apareix quan hi ha text, neteja i torna als populars

### Exemple d'integració

```typescript
import { FormulariCercaComponent } from './components/formulari-cerca/formulari-cerca.component';

@Component({
  imports: [FormulariCercaComponent],
  template: `<app-formulari-cerca />`
})
export class PageComponent {}
```{% endcapture %}
{% include code-block.html lang="markdown" code=code_040 %}

  <h3>7.9. Troubleshooting</h3>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Error</th>
        <th>Causa</th>
        <th>Solució</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>Can't bind to 'formGroup' since it isn't a known property</code></td>
        <td>ReactiveFormsModule no importat</td>
        <td>Afegir <code>ReactiveFormsModule</code> a imports del component</td>
      </tr>
      <tr>
        <td>Validador asíncron no s'executa</td>
        <td>Validador mal configurat</td>
        <td>Verificar que retorna <code>Observable&lt;ValidationErrors | null&gt;</code></td>
      </tr>
      <tr>
        <td>debounceTime no funciona</td>
        <td>RxJS operators mal importats</td>
        <td>Importar <code>import { debounceTime } from 'rxjs/operators'</code></td>
      </tr>
      <tr>
        <td>Formulari no reactiu</td>
        <td>FormGroup no inicialitzat</td>
        <td>Verificar que <code>ngOnInit()</code> crea el FormGroup</td>
      </tr>
      <tr>
        <td>valueChanges no s'activa</td>
        <td>Subscribe no cridat</td>
        <td>Afegir <code>.subscribe()</code> al final del pipe</td>
      </tr>
    </tbody>
  </table>

  <h3>7.10. Checkpoint</h3>

  {% include checklist.html elements="He creat el validador asíncron <code>codiDisponibleValidator</code>|He creat el component <code>FormulariCercaComponent</code>|He implementat el formulari reactiu amb <code>FormBuilder</code>|He afegit validació de longitud mínima (3 caràcters)|He implementat cerca automàtica amb <code>debounceTime</code>|He afegit indicadors visuals (spinner, botó netejar)|He integrat el formulari a <code>CatalegPageComponent</code>|He provat les 3 verificacions i funcionen correctament|He documentat el formulari a <code>docs/formularis.md</code>" %}

</div>

<!-- SECCIÓ 8: Preferits locals i formulari dinàmic -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio8">
  <h2 id="Unitat3_Bloc4_Seccio8">8. Preferits locals i formulari dinàmic</h2>

  <div class="info_box">
    <p><strong>Objectiu:</strong> Implementar sistema de preferits amb persistència a localStorage i formularis dinàmics amb FormArray per gestionar notes.</p>
    <p><strong>Integra conceptes de:</strong> Lectura 3.3.3 (Formularis complexos i camps dinàmics), Lectura 3.2.3 (Integració reactiva amb components).</p>
  </div>

  <h3>8.1. Crear servei de preferits</h3>

  <p><strong>PowerShell (Windows):</strong></p>

{% capture code_041 %}ng generate service serveis/preferits --skip-tests
code src\app\serveis\preferits.service.ts{% endcapture %}
{% include code-block.html lang="powershell" code=code_041 %}

  <p><strong>bash/zsh (macOS/Linux):</strong></p>

{% capture code_042 %}ng generate service serveis/preferits --skip-tests
code src/app/serveis/preferits.service.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_042 %}

  <h3>8.2. Implementar servei amb localStorage</h3>

  <p>Substituïu tot el contingut de <code>preferits.service.ts</code>:</p>

{% capture code_043 %}import { Injectable, signal } from '@angular/core';

export interface Preferit {
  elementId: string;
  elementNom: string;
  notes: string[];
  dataAfegit: Date;
}

@Injectable({
  providedIn: 'root'
})
export class PreferitsService {
  private readonly CLAU_STORAGE = 'catalog_preferits';
  private readonly preferitsSignal = signal<Preferit[]>([]);

  readonly preferits = this.preferitsSignal.asReadonly();

  constructor() {
    this.carregarPreferits();
  }

  /**
   * Carrega preferits des de localStorage
   */
  private carregarPreferits(): void {
    const dades = localStorage.getItem(this.CLAU_STORAGE);
    if (dades) {
      try {
        const preferits = JSON.parse(dades) as Preferit[];
        // Convertir strings de data a objectes Date
        preferits.forEach(p => p.dataAfegit = new Date(p.dataAfegit));
        this.preferitsSignal.set(preferits);
      } catch (error) {
        console.error('Error carregant preferits:', error);
        this.preferitsSignal.set([]);
      }
    }
  }

  /**
   * Desa preferits a localStorage
   */
  private desarPreferits(): void {
    localStorage.setItem(this.CLAU_STORAGE, JSON.stringify(this.preferitsSignal()));
  }

  /**
   * Afegeix un element als preferits
   */
  afegirPreferit(elementId: string, elementNom: string): void {
    if (this.esPreferit(elementId)) {
      return;
    }

    const nouPreferit: Preferit = {
      elementId,
      elementNom,
      notes: [],
      dataAfegit: new Date()
    };

    this.preferitsSignal.update(preferits => [...preferits, nouPreferit]);
    this.desarPreferits();
  }

  /**
   * Elimina un element dels preferits
   */
  eliminarPreferit(elementId: string): void {
    this.preferitsSignal.update(preferits =>
      preferits.filter(p => p.elementId !== elementId)
    );
    this.desarPreferits();
  }

  /**
   * Afegeix una nota a un preferit
   */
  afegirNota(elementId: string, nota: string): void {
    this.preferitsSignal.update(preferits =>
      preferits.map(p => {
        if (p.elementId === elementId) {
          return { ...p, notes: [...p.notes, nota] };
        }
        return p;
      })
    );
    this.desarPreferits();
  }

  /**
   * Elimina una nota d'un preferit
   */
  eliminarNota(elementId: string, indexNota: number): void {
    this.preferitsSignal.update(preferits =>
      preferits.map(p => {
        if (p.elementId === elementId) {
          const notesActualitzades = [...p.notes];
          notesActualitzades.splice(indexNota, 1);
          return { ...p, notes: notesActualitzades };
        }
        return p;
      })
    );
    this.desarPreferits();
  }

  /**
   * Comprova si un element és preferit
   */
  esPreferit(elementId: string): boolean {
    return this.preferitsSignal().some(p => p.elementId === elementId);
  }

  /**
   * Obté un preferit per ID
   */
  obtenirPreferit(elementId: string): Preferit | undefined {
    return this.preferitsSignal().find(p => p.elementId === elementId);
  }
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_043 %}

  <p><strong>Context:</strong> Aquest servei gestiona preferits amb persistència a <code>localStorage</code>:</p>
  <ul>
    <li>Carrega automàticament al inicialitzar</li>
    <li>Desa després de cada modificació</li>
    <li>Utilitza signals per reactivitat</li>
    <li>Suporta notes dinàmiques per cada preferit</li>
  </ul>

  <h3>8.3. Crear component de preferits</h3>

  <p><strong>PowerShell (Windows):</strong></p>

{% capture code_044 %}ng generate component components/preferits-panel --standalone --inline-style=false --inline-template=false --skip-tests
code src\app\components\preferits-panel\preferits-panel.component.ts{% endcapture %}
{% include code-block.html lang="powershell" code=code_044 %}

  <p><strong>bash/zsh (macOS/Linux):</strong></p>

{% capture code_045 %}ng generate component components/preferits-panel --standalone --inline-style=false --inline-template=false --skip-tests
code src/app/components/preferits-panel/preferits-panel.component.ts{% endcapture %}
{% include code-block.html lang="bash" code=code_045 %}

  <h3>8.4. Implementar component amb FormArray</h3>

  <p>Substituïu tot el contingut de <code>preferits-panel.component.ts</code>:</p>

{% capture code_046 %}import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormArray, FormBuilder, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
import { PreferitsService, Preferit } from '../../serveis/preferits.service';

@Component({
  selector: 'app-preferits-panel',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './preferits-panel.component.html',
  styleUrl: './preferits-panel.component.scss'
})
export class PreferitsPanelComponent implements OnInit {
  formulariNotes: FormGroup;
  preferitSeleccionat: Preferit | null = null;

  constructor(
    private fb: FormBuilder,
    public preferitsService: PreferitsService
  ) {
    this.formulariNotes = this.fb.group({
      notes: this.fb.array([])
    });
  }

  ngOnInit(): void {}

  get notes(): FormArray {
    return this.formulariNotes.get('notes') as FormArray;
  }

  seleccionarPreferit(preferit: Preferit): void {
    this.preferitSeleccionat = preferit;
    this.notes.clear();

    // Carregar notes existents al FormArray
    preferit.notes.forEach(nota => {
      this.notes.push(this.fb.control(nota, [Validators.required, Validators.minLength(3)]));
    });

    // Afegir camp buit per nova nota
    this.notes.push(this.fb.control('', [Validators.required, Validators.minLength(3)]));
  }

  afegirNota(): void {
    if (!this.preferitSeleccionat) return;

    // Obtenir última nota (la buida)
    const ultimIndex = this.notes.length - 1;
    const ultimControl = this.notes.at(ultimIndex);

    if (ultimControl.valid) {
      const nota = ultimControl.value;
      this.preferitsService.afegirNota(this.preferitSeleccionat.elementId, nota);

      // Recarregar preferit actualitzat
      const preferitActualitzat = this.preferitsService.obtenirPreferit(this.preferitSeleccionat.elementId);
      if (preferitActualitzat) {
        this.seleccionarPreferit(preferitActualitzat);
      }
    }
  }

  eliminarNota(index: number): void {
    if (!this.preferitSeleccionat) return;

    this.preferitsService.eliminarNota(this.preferitSeleccionat.elementId, index);

    // Recarregar preferit actualitzat
    const preferitActualitzat = this.preferitsService.obtenirPreferit(this.preferitSeleccionat.elementId);
    if (preferitActualitzat) {
      this.seleccionarPreferit(preferitActualitzat);
    } else {
      this.preferitSeleccionat = null;
      this.notes.clear();
    }
  }

  eliminarPreferit(elementId: string): void {
    this.preferitsService.eliminarPreferit(elementId);
    if (this.preferitSeleccionat?.elementId === elementId) {
      this.preferitSeleccionat = null;
      this.notes.clear();
    }
  }

  tancarPanel(): void {
    this.preferitSeleccionat = null;
    this.notes.clear();
  }
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_046 %}

  <p><strong>Context:</strong> Aquest component implementa:</p>
  <ul>
    <li><strong>FormArray dinàmic</strong> per gestionar múltiples notes</li>
    <li>Carrega notes existents al FormArray</li>
    <li>Afegeix i elimina notes dinàmicament</li>
    <li>Persiste canvis amb el servei de preferits</li>
  </ul>

  <h3>8.5. Crear plantilla del panel de preferits</h3>

  <p>Substituïu tot el contingut de <code>preferits-panel.component.html</code>:</p>

{% capture code_047 %}{% raw %}<div class="preferits-panel">
  <h2>Els meus preferits ({{ preferitsService.preferits().length }})</h2>

  <!-- Llista de preferits -->
  <div class="llista-preferits" *ngIf="preferitsService.preferits().length > 0">
    <div class="preferit-item" *ngFor="let preferit of preferitsService.preferits()" [class.seleccionat]="preferitSeleccionat?.elementId === preferit.elementId">
      <div class="preferit-info" (click)="seleccionarPreferit(preferit)">
        <h3>{{ preferit.elementNom }}</h3>
        <p class="notes-count">{{ preferit.notes.length }} notes</p>
        <p class="data-afegit">Afegit: {{ preferit.dataAfegit | date:'dd/MM/yyyy HH:mm' }}</p>
      </div>
      <button class="btn-eliminar" (click)="eliminarPreferit(preferit.elementId)">🗑️</button>
    </div>
  </div>

  <!-- Missatge si no hi ha preferits -->
  <div class="sense-preferits" *ngIf="preferitsService.preferits().length === 0">
    <p>No tens preferits encara</p>
    <p class="ajuda">Fes clic a l'estrella d'un element per afegir-lo als preferits</p>
  </div>

  <!-- Panel de notes (quan hi ha preferit seleccionat) -->
  <div class="panel-notes" *ngIf="preferitSeleccionat">
    <div class="notes-header">
      <h3>Notes de: {{ preferitSeleccionat.elementNom }}</h3>
      <button class="btn-tancar" (click)="tancarPanel()">✕</button>
    </div>

    <form [formGroup]="formulariNotes">
      <div class="notes-llista" formArrayName="notes">
        <div class="nota-item" *ngFor="let notaControl of notes.controls; let i = index">
          <input type="text" [formControlName]="i" [placeholder]="i === notes.length - 1 ? 'Escriu una nova nota...' : 'Nota ' + (i + 1)" class="input-nota" [class.invalid]="notaControl.invalid && notaControl.touched">
          <button type="button" class="btn-eliminar-nota" (click)="eliminarNota(i)" *ngIf="i < notes.length - 1">✕</button>
        </div>
      </div>

      <button type="button" class="btn-afegir-nota" (click)="afegirNota()" [disabled]="notes.at(notes.length - 1)?.invalid">Afegir nota</button>
    </form>
  </div>
</div>{% endraw %}{% endcapture %}
{% include code-block.html lang="html" code=code_047 %}

  <h3>8.6. Afegir estils al panel</h3>

  <p>Substituïu tot el contingut de <code>preferits-panel.component.scss</code>:</p>

{% capture code_048 %}.preferits-panel {
  background-color: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  margin-top: 2rem;

  h2 {
    margin: 0 0 1rem;
    color: #333;
  }
}

.llista-preferits {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-bottom: 1.5rem;

  .preferit-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 2px solid #eee;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;

    &:hover {
      border-color: #3498db;
      background-color: #f8f9fa;
    }

    &.seleccionat {
      border-color: #3498db;
      background-color: #e3f2fd;
    }

    .preferit-info {
      flex: 1;

      h3 {
        margin: 0 0 0.5rem;
        font-size: 1.1rem;
        color: #333;
      }

      .notes-count {
        margin: 0;
        font-size: 0.9rem;
        color: #3498db;
        font-weight: 600;
      }

      .data-afegit {
        margin: 0.25rem 0 0;
        font-size: 0.85rem;
        color: #999;
      }
    }

    .btn-eliminar {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 0.5rem;
      transition: transform 0.3s;

      &:hover {
        transform: scale(1.2);
      }
    }
  }
}

.sense-preferits {
  text-align: center;
  padding: 2rem;
  color: #666;

  p {
    margin: 0.5rem 0;
  }

  .ajuda {
    font-size: 0.9rem;
    color: #999;
  }
}

.panel-notes {
  border-top: 2px solid #eee;
  padding-top: 1.5rem;

  .notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;

    h3 {
      margin: 0;
      color: #333;
    }

    .btn-tancar {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
      transition: color 0.3s;

      &:hover {
        color: #e74c3c;
      }
    }
  }

  .notes-llista {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;

    .nota-item {
      display: flex;
      gap: 0.5rem;
      align-items: center;

      .input-nota {
        flex: 1;
        padding: 0.75rem;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.3s;

        &:focus {
          outline: none;
          border-color: #3498db;
        }

        &.invalid {
          border-color: #e74c3c;
        }
      }

      .btn-eliminar-nota {
        background-color: #e74c3c;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;

        &:hover {
          background-color: #c0392b;
        }
      }
    }
  }

  .btn-afegir-nota {
    width: 100%;
    background-color: #27ae60;
    color: white;
    border: none;
    padding: 0.75rem;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s;

    &:hover:not(:disabled) {
      background-color: #229954;
    }

    &:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
  }
}{% endcapture %}
{% include code-block.html lang="scss" code=code_048 %}

  <h3>8.7. Afegir botó de preferit a les targetes</h3>

  <p>Editeu <code>cataleg-page.component.html</code> actualitzant les targetes d'elements:</p>

{% capture code_049 %}{% raw %}<div class="element-card" *ngFor="let element of elementService.elements()">
  <img [src]="element.imatge" [alt]="element.nom" class="element-imatge">

  <!-- AFEGIR BOTÓ DE PREFERIT -->
  <button class="btn-preferit" [class.actiu]="preferitsService.esPreferit(element.id)" (click)="togglePreferit(element)">{{ preferitsService.esPreferit(element.id) ? '★' : '☆' }}</button>

  <div class="element-info">
    <!-- Resta del contingut... -->
  </div>
</div>{% endraw %}{% endcapture %}
{% include code-block.html lang="html" code=code_049 %}

  <p>Actualitzeu <code>cataleg-page.component.ts</code>:</p>

{% capture code_050 %}import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ElementService } from '../../serveis/element.service';
import { PreferitsService } from '../../serveis/preferits.service';  // ← Afegir
import { FormulariCercaComponent } from '../../components/formulari-cerca/formulari-cerca.component';
import { PreferitsPanelComponent } from '../../components/preferits-panel/preferits-panel.component';  // ← Afegir
import { ElementCataleg } from '../../models/element.model';  // ← Afegir

@Component({
  selector: 'app-cataleg-page',
  standalone: true,
  imports: [CommonModule, FormulariCercaComponent, PreferitsPanelComponent],  // ← Afegir PreferitsPanelComponent
  templateUrl: './cataleg-page.component.html',
  styleUrl: './cataleg-page.component.scss'
})
export class CatalegPageComponent implements OnInit {
  constructor(
    public elementService: ElementService,
    public preferitsService: PreferitsService  // ← Afegir
  ) {}

  ngOnInit(): void {
    this.elementService.obtenirPopulars();
  }

  reintentar(): void {
    this.elementService.obtenirPopulars();
  }

  togglePreferit(element: ElementCataleg): void {
    if (this.preferitsService.esPreferit(element.id)) {
      this.preferitsService.eliminarPreferit(element.id);
    } else {
      this.preferitsService.afegirPreferit(element.id, element.nom);
    }
  }
}{% endcapture %}
{% include code-block.html lang="typescript" code=code_050 %}

  <p>Afegiu els estils del botó a <code>cataleg-page.component.scss</code>:</p>

{% capture code_051 %}.element-card {
  position: relative;  // ← Afegir

  // ... resta d'estils ...

  .btn-preferit {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: white;
    border: 2px solid #f39c12;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

    &:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    &.actiu {
      background-color: #f39c12;
      color: white;
    }
  }
}{% endcapture %}
{% include code-block.html lang="scss" code=code_051 %}

  <h3>8.8. Integrar panel de preferits</h3>

  <p>Afegiu el panel a <code>cataleg-page.component.html</code> després del llistat:</p>

{% capture code_052 %}<!-- Després de </div> que tanca estat-exit -->

<!-- Panel de preferits -->
<app-preferits-panel />{% endcapture %}
{% include code-block.html lang="html" code=code_052 %}

  <h3>8.9. Provar sistema de preferits</h3>

  <p><strong>Verificació 1: Afegir preferit</strong></p>
  <ol>
    <li>Feu clic a l'estrella buida (☆) d'un element</li>
    <li>L'estrella es torna plena i daurada (★)</li>
    <li>El comptador de preferits s'incrementa</li>
    <li>L'element apareix al panel de preferits</li>
  </ol>

  <p><strong>Verificació 2: Notes dinàmiques</strong></p>
  <ol>
    <li>Feu clic a un preferit del panel</li>
    <li>S'obre el formulari de notes</li>
    <li>Escriviu una nota al camp buit</li>
    <li>Feu clic a "Afegir nota"</li>
    <li>La nota s'afegeix i apareix un nou camp buit</li>
  </ol>

  <p><strong>Verificació 3: Persistència</strong></p>
  <ol>
    <li>Afegiu 2-3 preferits amb notes</li>
    <li>Recarregueu la pàgina (F5)</li>
    <li>Els preferits i les notes continuen presents</li>
  </ol>

  <p><strong>Verificació 4: Eliminar</strong></p>
  <ol>
    <li>Elimineu una nota (botó ✕ vermell)</li>
    <li>Elimineu un preferit (botó 🗑️)</li>
    <li>Les eliminacions es reflecteixen immediatament</li>
  </ol>

  <h3>8.10. Documentar sistema de preferits</h3>

  <p>Actualitzeu <code>docs/formularis.md</code> afegint:</p>

{% capture code_053 %}## PreferitsPanelComponent

### Funcionalitat

Component amb FormArray dinàmic per gestionar notes de preferits amb persistència a localStorage.

### FormArray dinàmic

```typescript
formulariNotes = this.fb.group({
  notes: this.fb.array([])  // Array dinàmic de controls
});
```

**Comportament:**
1. Carrega notes existents al FormArray
2. Afegeix camp buit al final per noves notes
3. Validació: mínim 3 caràcters per nota
4. Persiste després de cada modificació

### Validacions

| Camp | Validació | Missatge |
|------|-----------|----------|
| Nota | `required, minLength(3)` | Validació visual (borde vermell) |

### Mètodes principals

- `seleccionarPreferit()`: Carrega notes del preferit al FormArray
- `afegirNota()`: Afegeix nota i recrea FormArray
- `eliminarNota()`: Elimina nota i actualitza FormArray

### Integració amb servei

```typescript
// Afegir nota
this.preferitsService.afegirNota(elementId, nota);

// Recarregar dades actualitzades
const actualitzat = this.preferitsService.obtenirPreferit(elementId);
this.seleccionarPreferit(actualitzat);
```{% endcapture %}
{% include code-block.html lang="markdown" code=code_053 %}

  <p>Actualitzeu <code>docs/serveis.md</code> afegint:</p>

{% capture code_054 %}## PreferitsService

### Responsabilitats

- Gestió de preferits amb localStorage
- Persistència automàtica després de cada modificació
- Gestió de notes dinàmiques per preferit

### Estructura de dades

```typescript
interface Preferit {
  elementId: string;
  elementNom: string;
  notes: string[];
  dataAfegit: Date;
}
```

### Mètodes

- `afegirPreferit(id, nom)`: Afegeix element als preferits
- `eliminarPreferit(id)`: Elimina preferit
- `afegirNota(id, nota)`: Afegeix nota a preferit
- `eliminarNota(id, index)`: Elimina nota específica
- `esPreferit(id)`: Comprova si element és preferit
- `obtenirPreferit(id)`: Retorna dades del preferit

### localStorage

- **Clau:** `'catalog_preferits'`
- **Format:** JSON string
- **Càrrega:** Automàtica al inicialitzar servei
- **Desat:** Després de cada modificació{% endcapture %}
{% include code-block.html lang="markdown" code=code_054 %}

  <h3>8.11. Troubleshooting</h3>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Error</th>
        <th>Causa</th>
        <th>Solució</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>localStorage is not defined</code></td>
        <td>Accés a localStorage en SSR</td>
        <td>Afegir comprovació: <code>if (typeof localStorage !== 'undefined')</code></td>
      </tr>
      <tr>
        <td>FormArray no s'actualitza</td>
        <td>No es crida <code>updateValueAndValidity()</code></td>
        <td>Cridar després de modificar FormArray</td>
      </tr>
      <tr>
        <td>Notes duplicades</td>
        <td>Múltiples crides a <code>afegirNota()</code></td>
        <td>Afegir comprovació abans d'afegir</td>
      </tr>
      <tr>
        <td>Dates no es deserialitzen</td>
        <td>JSON.parse no converteix strings</td>
        <td>Convertir manualment: <code>new Date(dateString)</code></td>
      </tr>
      <tr>
        <td>Preferits es perden</td>
        <td>localStorage bloquejat</td>
        <td>Verificar configuració del navegador</td>
      </tr>
      <tr>
        <td>Aplicació lenta</td>
        <td>json-server amb delay massa alt</td>
        <td>Reduir <code>--delay</code> a 300ms per desenvolupament</td>
      </tr>
      <tr>
        <td>Memory leak</td>
        <td>Subscripcions no cancel·lades</td>
        <td>Usar <code>takeUntilDestroyed()</code> o <code>async</code> pipe</td>
      </tr>
      <tr>
        <td>Signals no reactives</td>
        <td>No usar parèntesis <code>()</code></td>
        <td>Sempre cridar signals: <code>estat()</code> no <code>estat</code></td>
      </tr>
      <tr>
        <td>Tests fallen</td>
        <td>Mocks no configurats</td>
        <td>Afegir <code>HttpClientTestingModule</code> i mocks de serveis</td>
      </tr>
      <tr>
        <td>Build error</td>
        <td>Imports circulars</td>
        <td>Revisar imports i crear barrel files si cal</td>
      </tr>
    </tbody>
  </table>

  <h3>8.12. Checkpoint</h3>

  {% include checklist.html elements="He creat el servei <code>PreferitsService</code> amb localStorage|He implementat el component <code>PreferitsPanelComponent</code> amb FormArray|He afegit el botó de preferit a les targetes d'elements|Puc afegir i eliminar preferits correctament|Puc afegir notes dinàmiques amb validació|Puc eliminar notes individuals|Els preferits persisteixen després de recarregar la pàgina|He documentat el sistema de preferits completament" %}

</div>

<!-- SECCIÓ 9: Verificació final i control de versions -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio9">
  <h2 id="Unitat3_Bloc4_Seccio9">9. Verificació final i control de versions</h2>

  <h3>9.1. Executar linter</h3>

  <p><strong>PowerShell (Windows):</strong></p>

{% capture code_055 %}npm run lint{% endcapture %}
{% include code-block.html lang="powershell" code=code_055 %}

  <p><strong>bash/zsh (macOS/Linux):</strong></p>

{% capture code_056 %}npm run lint{% endcapture %}
{% include code-block.html lang="bash" code=code_056 %}

  <p><strong>Verificació:</strong> No hi ha d'haver errors de linting. Si n'hi ha, corregiu-los abans de continuar.</p>

  <h3>9.2. Executar tests</h3>

  <p>Si teniu tests configurats al projecte:</p>

{% capture code_057 %}npm run test -- --watch=false --browsers=ChromeHeadless{% endcapture %}
{% include code-block.html lang="bash" code=code_057 %}

  <h3>9.3. Build de producció</h3>

  <p>Verifiqueu que el build es completa sense errors:</p>

{% capture code_058 %}ng build --configuration production{% endcapture %}
{% include code-block.html lang="bash" code=code_058 %}

  <p><strong>Verificació:</strong> El build es completa sense errors i genera fitxers a <code>dist/</code>.</p>

  <h3>9.4. Revisar documentació</h3>

  <p>Verifiqueu que tots els fitxers de documentació estan actualitzats:</p>

{% capture code_059 %}ls docs/
# Ha de mostrar: serveis.md, models.md, formularis.md{% endcapture %}
{% include code-block.html lang="bash" code=code_059 %}

  <p>Obriu cada fitxer i verifiqueu que conté:</p>
  <ul>
    <li>Configuració de l'API</li>
    <li>Models i adaptadors documentats</li>
    <li>Serveis amb exemples d'ús</li>
    <li>Formularis amb validacions</li>
    <li>Sistema de preferits explicat</li>
  </ul>

  <h3>9.5. Commit final</h3>

  <p><strong>PowerShell (Windows):</strong></p>

{% capture code_060 %}git status
git add .
git commit -m "feat(u3-cas-us): catàleg complet amb API, cerca i preferits

- Configuració servidor mock amb json-server
- Models TypeScript amb adaptadors
- Servei HTTP amb gestió d'estats (signals)
- Llistat reactiu amb indicadors de càrrega i error
- Formulari de cerca amb validació i debounce
- Sistema de preferits amb notes dinàmiques (FormArray)
- Persistència a localStorage
- Documentació completa de serveis, models i formularis"{% endcapture %}
{% include code-block.html lang="powershell" code=code_060 %}

  <p><strong>bash/zsh (macOS/Linux):</strong></p>

{% capture code_061 %}git status
git add .
git commit -m "feat(u3-cas-us): catàleg complet amb API, cerca i preferits

- Configuració servidor mock amb json-server
- Models TypeScript amb adaptadors
- Servei HTTP amb gestió d'estats (signals)
- Llistat reactiu amb indicadors de càrrega i error
- Formulari de cerca amb validació i debounce
- Sistema de preferits amb notes dinàmiques (FormArray)
- Persistència a localStorage
- Documentació completa de serveis, models i formularis"{% endcapture %}
{% include code-block.html lang="bash" code=code_061 %}

  <h3>9.6. Crear etiqueta (opcional)</h3>

{% capture code_062 %}git tag -a v3.4.1 -m "Cas d'ús U3.4.1: Catàleg amb dades remotes"
git tag -l{% endcapture %}
{% include code-block.html lang="bash" code=code_062 %}

  <h3>9.7. Checkpoint</h3>

  {% include checklist.html elements="El linter no reporta errors|Els tests passen correctament (si n'hi ha)|Build de producció exitós|Tots els fitxers de documentació estan complets|Commit final creat amb missatge descriptiu|Etiqueta <code>v3.4.1</code> creada (opcional)|<code>git status</code> mostra working tree net" %}

</div>

<!-- SECCIÓ 10: Autoavaluació -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio10">
  <h2 id="Unitat3_Bloc4_Seccio10">10. Autoavaluació</h2>

  <h3>Definition of Done</h3>

  <p><strong>L'aplicació està completa quan:</strong></p>

  <p><strong>Funcionalitat API:</strong></p>
  {% include checklist.html elements="He configurat json-server al port 4301 amb 5 elements|He verificat que l'API respon amb latència (~600ms)|He creat fitxer d'entorn amb URL de l'API|He documentat la configuració a <code>docs/serveis.md</code>" %}

  <p><strong>Models i adaptadors:</strong></p>
  {% include checklist.html elements="He creat interfícies <code>ElementCataleg</code> i <code>ElementApiResponse</code>|He implementat adaptadors <code>adaptarElementApi</code> i <code>adaptarElementsApi</code>|He provat els adaptadors amb dades mock|He documentat models i mapeig de camps a <code>docs/models.md</code>" %}

  <p><strong>Servei HTTP:</strong></p>
  {% include checklist.html elements="He creat <code>ElementService</code> amb signals|He implementat mètodes <code>obtenirPopulars()</code> i <code>cercar()</code>|He afegit gestió d'errors amb missatges comprensibles|He provat el servei des de la consola del navegador" %}

  <p><strong>Llistat reactiu:</strong></p>
  {% include checklist.html elements="He creat component <code>CatalegPage</code> amb gestió d'estats|Veig spinner de càrrega correctament|Veig missatge d'error quan l'API no respon|El botó \"Reintentar\" funciona correctament|Els elements es mostren en graella responsiva" %}

  <p><strong>Formulari de cerca:</strong></p>
  {% include checklist.html elements="He creat formulari reactiu amb validació de longitud|La cerca automàtica amb debounce funciona|El botó de netejar apareix i funciona|Veig indicador de càrrega durant la cerca|He documentat validacions a <code>docs/formularis.md</code>" %}

  <p><strong>Sistema de preferits:</strong></p>
  {% include checklist.html elements="He creat servei de preferits amb localStorage|Puc afegir i eliminar preferits|Puc afegir notes dinàmiques amb FormArray|Puc eliminar notes individuals|Els preferits persisteixen després de recarregar|He documentat el sistema a <code>docs/serveis.md</code> i <code>docs/formularis.md</code>" %}

  <p><strong>Control de versions:</strong></p>
  {% include checklist.html elements="He fet commit final amb missatge descriptiu|He creat etiqueta <code>v3.4.1</code> (opcional)|<code>git status</code> mostra working tree net" %}

  <h3>Competències adquirides</h3>

  <p><strong>Comunicació amb APIs:</strong></p>
  {% include checklist.html elements="Sé configurar un servidor mock amb json-server|Puc crear serveis Angular amb HttpClient|Gestiono correctament estats de càrrega i error|Implemento gestió d'errors amb missatges comprensibles" %}

  <p><strong>Models i transformació de dades:</strong></p>
  {% include checklist.html elements="Defineixo models TypeScript amb interfícies|Creo adaptadors per transformar dades externes|Mapejo camps de l'API al format intern|Documento mapejos de camps clarament" %}

  <p><strong>Reactivitat i signals:</strong></p>
  {% include checklist.html elements="Utilitzo signals per gestió d'estat reactiu|Exposo signals com a només lectura|Actualitzo signals des de serveis|Consumeixo signals des de components" %}

  <p><strong>Formularis avançats:</strong></p>
  {% include checklist.html elements="Creo formularis reactius amb FormBuilder|Implemento validadors síncrons i asíncrons|Gestiono FormArray dinàmics|Afegeixo i elimino controls dinàmicament" %}

  <p><strong>Persistència local:</strong></p>
  {% include checklist.html elements="Utilitzo localStorage per desar dades|Serialitzo i deserialitzo JSON correctament|Gestiono errors de localStorage|Implemento carrega automàtica a l'inicialitzar" %}

  <p><strong>Bones pràctiques:</strong></p>
  {% include checklist.html elements="Separo responsabilitats (serveis, components, adaptadors)|Documento decisions tècniques|Utilitzo control de versions amb commits descriptius|Valido amb linter i build de producció" %}

</div>

<!-- SECCIÓ 11: Recapitulació i contracte de sortida -->
<div class="section cas-dus" id="Unitat3_Bloc4_Seccio11">
  <h2 id="Unitat3_Bloc4_Seccio11">11. Recapitulació i contracte de sortida</h2>

  <h3>Què hem aconseguit</h3>

  <p>Disposeu d'una <strong>aplicació Angular completa</strong> que integra tots els conceptes de la Unitat 3:</p>

  <ol>
    <li><strong>Consum de serveis externs:</strong> Servidor mock amb json-server, peticions HTTP amb <code>HttpClient</code>, gestió d'errors i estats</li>
    <li><strong>Models i adaptadors:</strong> Interfícies TypeScript, transformació de dades externes, mapeig de camps</li>
    <li><strong>Reactivitat amb signals:</strong> Gestió d'estat reactiu, signals només lectura, integració amb components</li>
    <li><strong>Formularis avançats:</strong> Formularis reactius, validacions síncrones i asíncrones, debounce per cerca</li>
    <li><strong>Camps dinàmics:</strong> FormArray per gestionar notes, afegir/eliminar controls dinàmicament</li>
    <li><strong>Persistència local:</strong> localStorage per preferits, serialització/deserialització automàtica</li>
  </ol>

  <h3>Què queda preparat per a la Unitat 4</h3>

  <p>A la <strong>Unitat 4 (RA4 - Navegació i optimització)</strong> podreu:</p>

  <ul>
    <li>Afegir <strong>sistema de rutes</strong> per navegar entre pàgines (llistat, detall, preferits)</li>
    <li>Implementar <strong>rutes niades</strong> per mostrar notes dins de detalls d'elements</li>
    <li>Afegir <strong>guàrdies de ruta</strong> per protegir l'accés a preferits</li>
    <li>Aplicar <strong>lazy loading</strong> per carregar components només quan calguin</li>
    <li>Optimitzar <strong>rendiment</strong> amb detecció de canvis i virtualització</li>
  </ul>

  <p>L'arquitectura actual (serveis, models, adaptadors) és la base sòlida sobre la qual construireu la navegació.</p>

  <h3>Contracte de sortida</h3>

  <div class="alert alert-success">
    <ul class="list-unstyled mb-0">
      <li><i class="bi bi-check-circle-fill text-success"></i> Aplicació Angular funcional amb 4 funcionalitats principals</li>
      <li><i class="bi bi-check-circle-fill text-success"></i> Servidor mock configurat i documentat</li>
      <li><i class="bi bi-check-circle-fill text-success"></i> Models i adaptadors testejats i documentats</li>
      <li><i class="bi bi-check-circle-fill text-success"></i> Servei HTTP amb gestió d'estats completa</li>
      <li><i class="bi bi-check-circle-fill text-success"></i> Formularis reactius amb validacions avançades</li>
      <li><i class="bi bi-check-circle-fill text-success"></i> Sistema de preferits amb persistència local</li>
      <li><i class="bi bi-check-circle-fill text-success"></i> Documentació tècnica completa (3 fitxers docs/)</li>
      <li><i class="bi bi-check-circle-fill text-success"></i> Control de versions amb commit descriptiu</li>
    </ul>
  </div>

  <p class="text-center mt-4"><strong>Esteu preparats per afrontar la Unitat 4 amb confiança!</strong></p>

  <h3>Referències ràpides</h3>

  <p><strong>Arrencar servidor de desenvolupament:</strong></p>

{% capture code_063 %}# Terminal 1: Servidor mock
json-server --watch tools/api/cataleg.json --port 4301 --delay 600

# Terminal 2: Aplicació Angular
ng serve{% endcapture %}
{% include code-block.html lang="bash" code=code_063 %}

  <p><strong>Comandes essencials:</strong></p>

{% capture code_064 %}ng serve                    # Arrencar app (http://localhost:4200)
ng build                    # Build de producció
npm run lint                # Validar codi
git status                  # Estat del repositori{% endcapture %}
{% include code-block.html lang="bash" code=code_064 %}

  <p><strong>Troubleshooting ràpid:</strong></p>

  <ul>
    <li>API no respon → Verificar json-server actiu al port 4301</li>
    <li>Elements no es carreguen → Comprovar estat del servei a consola</li>
    <li>Preferits no persisteixen → Verificar localStorage habilitat</li>
    <li>Validacions no funcionen → Comprovar imports de ReactiveFormsModule</li>
    <li>Signals no reactives → Usar parèntesis: <code>estat()</code> no <code>estat</code></li>
  </ul>

  <p><strong>Resolució de problemes detallada:</strong> Vegeu seccions de Troubleshooting de cada bloc</p>

  <h3>Prompts d'IA</h3>

  <p>Podeu usar IA per resoldre dubtes o ampliar coneixements:</p>

  {% include prompt-ai.html contingut="<strong>Rol:</strong> Ets un desenvolupador Angular senior especialitzat en arquitectura d'aplicacions web i patrons de disseny. <strong>Context:</strong> He completat el cas d'ús U3.4.1 d'un curs introductori d'Angular on he implementat una aplicació de catàleg amb consum d'API, gestió d'estats amb signals, formularis reactius i persistència local. <strong>Tasca:</strong> Proposa 3 millores arquitecturals per escalabilitat que pugui implementar, explicant els beneficis de cada una i proporcionant un exemple de codi concret. <strong>Format:</strong> Llista numerada amb títol, beneficis (3-4 punts) i bloc de codi TypeScript per cada millora." %}

  {% include prompt-ai.html contingut="<strong>Rol:</strong> Ets un expert en testing d'aplicacions Angular. <strong>Context:</strong> Tinc una aplicació Angular amb servei HTTP que consumeix dades d'una API, servei de preferits amb localStorage i formularis reactius amb validacions asíncrones. <strong>Tasca:</strong> Genera un pla de testing complet amb 10 casos de prova distribuïts entre tests unitaris (serveis, adaptadors) i tests d'integració (components). Prioritza els casos més crítics. <strong>Format:</strong> Taula amb columnes: Prioritat (Alta/Mitjana/Baixa), Tipus (Unitari/Integració), Component/Servei, Escenari a provar, Resultat esperat." %}

  {% include prompt-ai.html contingut="<strong>Rol:</strong> Ets un analista de rendiment d'aplicacions web. <strong>Context:</strong> He implementat una aplicació Angular que fa peticions HTTP amb gestió d'estats, cerca amb debounce i FormArray dinàmics. <strong>Tasca:</strong> Identifica 5 possibles colls d'ampolla de rendiment en aquesta arquitectura i proposa solucions específiques amb exemples de codi RxJS o optimitzacions d'Angular. <strong>Format:</strong> Llista amb estructura: Problema detectat → Impacte (Crític/Alt/Mitjà) → Solució proposada → Bloc de codi." %}

</div>
